---
import MainLayout from '../../layouts/MainLayout.astro';
import { getPostBySlug, getPosts } from '../../backend/db.js';

// Get the slug from the URL
const { slug } = Astro.params;

// Fetch the post data
const post = await getPostBySlug(slug);

// If post not found, return 404
if (!post) {
  return Astro.redirect('/404');
}

// Format date
const formattedDate = new Date(post.created_at).toLocaleDateString('de-DE', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Get related posts
const relatedPosts = await getPosts({
  limit: 3,
  category: post.category_slug,
});
---

<MainLayout 
  title={post.title}
  description={post.meta_description || post.excerpt}
>
  <article class="py-12">
    <div class="container max-w-4xl">
      <!-- Post Header -->
      <header class="mb-8">
        {post.category_name && (
          <a 
            href={`/blog/category/${post.category_slug}`}
            class="inline-block text-teal-600 font-medium mb-4 hover:underline"
          >
            {post.category_name}
          </a>
        )}
        
        <h1 class="text-4xl md:text-5xl font-bold mb-6">{post.title}</h1>
        
        <div class="flex items-center text-gray-600 mb-8">
          <span class="mr-4">
            <i class="far fa-calendar mr-2"></i>
            {formattedDate}
          </span>
          
          {post.author_name && (
            <span>
              <i class="far fa-user mr-2"></i>
              {post.author_name}
            </span>
          )}
        </div>
        
        {post.image && (
          <div class="aspect-video overflow-hidden rounded-lg mb-8">
            <img 
              src={post.image} 
              alt={post.title} 
              class="w-full h-full object-cover"
            />
          </div>
        )}
        
        {post.excerpt && (
          <p class="text-xl text-gray-600 mb-8">{post.excerpt}</p>
        )}
      </header>
      
      <!-- Post Content -->
      <div class="prose prose-lg max-w-none">
        {post.content}
      </div>
    </div>
  </article>
  
  <!-- Related Posts -->
  {relatedPosts.length > 0 && relatedPosts.some(p => p.id !== post.id) && (
    <section class="py-12 bg-gray-50">
      <div class="container">
        <h2 class="text-3xl font-bold mb-8">Verwandte Beitru00e4ge</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          {relatedPosts
            .filter(p => p.id !== post.id)
            .slice(0, 3)
            .map(relatedPost => (
              <a href={`/blog/${relatedPost.slug}`} class="card hover:shadow-lg transition-shadow">
                {relatedPost.image && (
                  <div class="aspect-video overflow-hidden">
                    <img 
                      src={relatedPost.image} 
                      alt={relatedPost.title} 
                      class="w-full h-full object-cover transition-transform hover:scale-105"
                    />
                  </div>
                )}
                
                <div class="p-6">
                  <h3 class="text-xl font-bold mb-2">{relatedPost.title}</h3>
                  {relatedPost.excerpt && (
                    <p class="text-gray-600">{relatedPost.excerpt}</p>
                  )}
                </div>
              </a>
            ))
          }
        </div>
      </div>
    </section>
  )}
</MainLayout>